---
/**
 * Shared bottom navigation bar component
 * Used across main pages and blog posts with different configurations
 */
import LanguageSwitcher from './LanguageSwitcher.astro';
import '../styles/components/bottom-nav.css';

interface Props {
  /** Current page for highlighting active nav link */
  currentPage?: string;
  /** Variant: 'main' for home/projects/blogs, 'blog' for blog posts */
  variant?: 'main' | 'blog';
  /** Blog-specific props */
  lang?: 'en' | 'vi';
  slug?: string;
  langs?: ('en' | 'vi')[];
}

const { 
  currentPage = '', 
  variant = 'main',
  lang = 'en',
  slug = '',
  langs = ['en', 'vi']
} = Astro.props;

const navLinks = [
  { href: '/', label: 'home' },
  { href: '/projects', label: 'projects' },
  { href: '/blogs', label: 'blogs' },
];

const backLabel = lang === 'vi' ? 'Quay l·∫°i' : 'Back';
---

<nav class="bottom-nav" aria-label="Navigation">
  <div class="bottom-nav__pill">
    {variant === 'main' && navLinks.map(link => (
      <a 
        class:list={['bottom-nav__link', { 'is-active': currentPage === link.label }]}
        href={link.href}
      >
        {link.label}
      </a>
    ))}
    
    {variant === 'blog' && (
      <>
        <LanguageSwitcher currentLang={lang} slug={slug} langs={langs} />
        <a href="/blogs" class="bottom-nav__link">{backLabel}</a>
      </>
    )}
    
    <span class="bottom-nav__divider"></span>
    
    <button 
      id="bottom-theme-toggle" 
      class="bottom-nav__theme" 
      type="button" 
      aria-label="Toggle theme"
    >
      <span class="bottom-nav__theme-icon">‚òÄÔ∏è</span>
    </button>
  </div>
</nav>

<script>
  /**
   * Theme toggle functionality for bottom nav
   */
  const themeToggle = document.getElementById('bottom-theme-toggle');
  const themeIcon = themeToggle?.querySelector('.bottom-nav__theme-icon');
  
  function updateThemeIcon(): void {
    if (!themeIcon) return;
    const isDark = document.documentElement.dataset.theme === 'dark';
    themeIcon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
  }
  
  // Force repaint for mobile browsers
  function forceRepaint(): void {
    // Toggle grid opacity to force body::before repaint
    document.body.style.setProperty('--grid-opacity', '0.71');
    void document.body.offsetHeight;
    document.body.style.setProperty('--grid-opacity', '0.7');
    void document.body.offsetHeight;
    document.body.style.removeProperty('--grid-opacity');
    
    // Force reflow
    void document.documentElement.offsetHeight;
    void document.body.offsetHeight;
    getComputedStyle(document.body);
    getComputedStyle(document.documentElement);
    
    // Force repaint of key elements
    document.querySelectorAll('section, main, header, footer, .hero, .btn, .pill').forEach(el => {
      void (el as HTMLElement).offsetHeight;
      getComputedStyle(el);
    });
  }
  
  function toggleTheme(): void {
    const current = document.documentElement.dataset.theme;
    const next = current === 'dark' ? 'light' : 'dark';
    
    // Disable transitions temporarily
    const style = document.createElement('style');
    style.textContent = '* { transition: none !important; }';
    document.head.appendChild(style);
    
    // Update theme
    document.documentElement.dataset.theme = next;
    document.documentElement.style.colorScheme = next;
    localStorage.setItem('theme', next);
    
    // Update icon
    updateThemeIcon();
    
    // Force repaint (critical for mobile)
    forceRepaint();
    
    // Re-enable transitions
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        document.head.removeChild(style);
      });
    });
    
    // Dispatch event
    window.dispatchEvent(new CustomEvent('themechange', { detail: { theme: next } }));
  }
  
  // Set initial icon
  updateThemeIcon();
  
  // Watch for theme changes
  const observer = new MutationObserver(updateThemeIcon);
  observer.observe(document.documentElement, { 
    attributes: true, 
    attributeFilter: ['data-theme'] 
  });
  
  // Handle click
  themeToggle?.addEventListener('click', toggleTheme);
</script>

